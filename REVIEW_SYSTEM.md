# Review System Documentation

## Overview

The review system allows attendees to leave feedback for each other after events, with optional QR code check-in verification. The system includes comprehensive anti-abuse mechanisms and can be completely disabled via feature flags.

## Database Schema

### Core Tables

1. **`event_checkins`** - Tracks who actually attended events via QR code scanning
2. **`event_qr_codes`** - QR codes generated by hosts for check-in verification
3. **`reviews`** - The actual reviews with ratings and text
4. **`review_flags`** - User-reported problematic reviews
5. **`review_votes`** - Community voting on review helpfulness
6. **`feature_flags`** - Toggle entire review system on/off

## How It Works

### Step 1: Event Check-In (Optional but Recommended)

**For Hosts:**
1. Navigate to your event page
2. Click "Generate Check-In QR Code"
3. A unique QR code is created for this event
4. Show the QR code at the event location

**For Attendees:**
1. At the event, scan the host's QR code
2. System records check-in with timestamp
3. User gets "Verified Attendee" badge
4. Their reviews carry more weight

**Implementation:**
```typescript
// Generate QR Code (host only)
const { data, error } = await supabase
  .from('event_qr_codes')
  .insert({
    event_id: eventId,
    code: generateUniqueCode(), // UUID or custom format
    created_by: hostId,
    expires_at: eventEndTime // Optional
  })
  .select()
  .single()

// Check-in via QR scan
const { data, error } = await supabase
  .from('event_checkins')
  .insert({
    event_id: eventId,
    user_id: currentUserId,
    qr_code_id: scannedQRCodeId,
    check_in_method: 'qr_code'
  })
```

### Step 2: Leaving Reviews

**Who Can Review:**
- Any attendee who joined the event
- After event end time has passed
- Each attendee can review every other attendee (peer reviews)
- Cannot review yourself

**Review Requirements:**
- Overall rating (1-5 stars) - **Required**
- Optional detailed ratings: friendliness, communication, reliability
- Text review: 10-1000 characters - **Optional**
- Can only review once per person per event

**Review Window:**
- Available after event ends
- Can edit for 48 hours after submission
- After 48 hours, review is locked

**Implementation:**
```typescript
// Leave a review
const { data, error } = await supabase
  .from('reviews')
  .insert({
    event_id: eventId,
    reviewer_id: currentUserId,
    reviewee_id: personBeingReviewedId,
    overall_rating: 5,
    friendliness_rating: 5, // optional
    communication_rating: 4, // optional
    reliability_rating: 5, // optional
    review_text: 'Great person to hang out with!',
    is_verified_attendee: hasCheckedIn // from event_checkins table
  })

// Check if user can leave review
const canReview = 
  eventHasEnded && 
  userAttendedEvent && 
  !alreadyReviewedThisPerson &&
  within48HoursOrNew
```

### Step 3: Displaying Reviews

**Minimum Threshold:**
- Profile must have at least **5 reviews** before showing average rating
- Below 5 reviews: Show count but hide rating
- This prevents unfair judgment from 1-2 bad reviews

**Display Format:**
```
‚≠ê 4.7 (23 reviews) ‚úì 18 verified

Rating Breakdown:
‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 75% (18 reviews)
‚≠ê‚≠ê‚≠ê‚≠ê 20% (5 reviews)
‚≠ê‚≠ê‚≠ê 5% (1 review)
‚≠ê‚≠ê 0%
‚≠ê 0%
```

**Implementation:**
```typescript
// Get user's review stats
const { data: stats } = await supabase
  .from('profile_review_stats')
  .select('*')
  .eq('profile_id', userId)
  .single()

// Only show if >= 5 reviews
if (stats && stats.total_reviews >= 5) {
  displayRating(stats.average_rating, stats.total_reviews)
} else {
  displayMessage(`${stats?.total_reviews || 0} reviews (minimum 5 to show rating)`)
}
```

## Anti-Abuse Mechanisms

### 1. **Account Age Requirement**
```typescript
// Check account age before allowing review
const accountAge = Date.now() - userCreatedAt
const canReview = accountAge >= 7 * 24 * 60 * 60 * 1000 // 7 days
```

### 2. **Rate Limiting**
- One review per person per event
- Database constraint: `UNIQUE(event_id, reviewer_id, reviewee_id)`
- Can't review same person more than once per month (implement in app logic)

### 3. **Auto-Flagging**
- Profanity detection (expand the word list in migration)
- Auto-flag reviews containing hate speech
- Flag if same text appears in multiple reviews (spam detection)

```sql
-- Add more profanity words to check_review_profanity() function
profanity_words TEXT[] := ARRAY['spam', 'fake', 'scam', 'hate', 'racist', ...]
```

### 4. **Community Moderation**
```typescript
// Users can flag inappropriate reviews
const { error } = await supabase
  .from('review_flags')
  .insert({
    review_id: reviewId,
    flagger_id: currentUserId,
    reason: 'inappropriate',
    additional_info: 'Contains personal attacks'
  })

// Auto-hide review after 3+ flags (implement in app logic)
if (review.flag_count >= 3) {
  await supabase
    .from('reviews')
    .update({ is_hidden: true })
    .eq('id', reviewId)
}
```

### 5. **Verified Attendee Weight**
- Reviews from QR-verified attendees count more in aggregate scores
- Badge displayed on verified reviews
- Non-verified reviews still shown but with less prominence

### 6. **Response System**
```typescript
// Person being reviewed can respond
const { error } = await supabase
  .from('reviews')
  .update({
    response_text: 'Thanks for the feedback!',
    response_at: new Date().toISOString()
  })
  .eq('id', reviewId)
  .eq('reviewee_id', currentUserId) // Only reviewee can respond
```

### 7. **Review Deletion**
```typescript
// Can delete own review within 48 hours
const canDelete = 
  review.reviewer_id === currentUserId &&
  new Date() < new Date(review.can_edit_until)

if (canDelete) {
  await supabase
    .from('reviews')
    .delete()
    .eq('id', reviewId)
}
```

### 8. **Statistical Outlier Detection**
```typescript
// Flag reviews that are statistical outliers
const userAverage = 4.7
const newReview = 1 // Suspiciously low
const standardDeviation = 0.5

if (Math.abs(newReview - userAverage) > 2 * standardDeviation) {
  // Flag for manual review
  await flagForModeration(reviewId, 'Statistical outlier')
}
```

## Feature Flags (Kill Switch)

### Disabling the Entire System

```sql
-- Turn off reviews completely
UPDATE public.feature_flags 
SET is_enabled = false 
WHERE feature_name = 'review_system';

-- Turn off just QR check-ins
UPDATE public.feature_flags 
SET is_enabled = false 
WHERE feature_name = 'qr_checkins';
```

### In Your App Code

```typescript
// Check if reviews are enabled
const { data: flags } = await supabase
  .from('feature_flags')
  .select('is_enabled')
  .eq('feature_name', 'review_system')
  .single()

const reviewsEnabled = flags?.is_enabled ?? false

// Conditionally render review UI
{reviewsEnabled && (
  <ReviewSection />
)}
```

**Recommendation:** Create a React context for feature flags:

```typescript
// contexts/FeatureFlagsContext.tsx
export const FeatureFlagsContext = createContext({
  reviewsEnabled: false,
  qrCheckinsEnabled: false
})

// Check once on app load
useEffect(() => {
  fetchFeatureFlags()
}, [])
```

## UI Components Needed

### 1. QR Code Generator (Host)
- Button on event page (only for host)
- Generate and display QR code
- Show scan count
- Regenerate if needed

### 2. QR Scanner (Attendees)
- Camera access for scanning
- Verify QR belongs to current event
- Success confirmation
- Badge on profile

### 3. Review Form
- Star ratings (with hover effects)
- Optional text area
- Character counter (10-1000)
- Preview before submit
- "Verified attendee" badge if checked in

### 4. Review Display
- Star rating with count
- Review text
- Reviewer name + avatar
- Verified badge
- Helpful/Not helpful buttons
- Flag button
- Response from reviewee (if any)
- Timestamp

### 5. Profile Review Section
```
üë§ Reviews (23)

Overall Rating: ‚≠ê 4.7 (18 verified)

Recent Reviews:
-----------------
‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Great person! - Sarah M. ‚úì
"Really friendly and punctual. Would attend events with again!"
[Helpful 5] [Not helpful 0] [Flag]

Response: Thanks Sarah! Had a great time too!
---
‚≠ê‚≠ê‚≠ê‚≠ê Good vibes - John D.
"Nice to meet, just was a bit quiet"
[Helpful 2] [Not helpful 0] [Flag]
```

## Best Practices

### For Hosts:
1. **Generate QR early** - Create QR code when creating event
2. **Display prominently** - Print QR or show on phone at event
3. **Encourage check-ins** - Remind attendees to scan
4. **Lead by example** - Leave thoughtful reviews for attendees

### For Attendees:
1. **Check in** - Get verified badge for credibility
2. **Be honest but kind** - Constructive feedback only
3. **Wait 24 hours** - Cool off before reviewing negative experiences
4. **Focus on behavior** - Not personal characteristics

### For Platform:
1. **Monitor flags** - Review flagged content regularly
2. **Ban bad actors** - Remove users who abuse the system
3. **Refresh stats** - Run `SELECT refresh_review_stats()` nightly
4. **Watch metrics** - Track review volume, flags, verified %

## Privacy Considerations

1. **Reviews are public** - Anyone can see them
2. **No edit history** - Once edited, old version is gone
3. **Can't delete after 48h** - Prevents manipulation
4. **IP hashing** - Store hashed IPs, not raw IPs
5. **GDPR compliance** - Allow users to request review removal

## Moderation Queue

Build an admin panel with:

```sql
-- Get flagged reviews
SELECT 
  r.*,
  p.full_name as reviewer_name,
  COUNT(rf.id) as flag_count
FROM reviews r
JOIN profiles p ON r.reviewer_id = p.id
LEFT JOIN review_flags rf ON r.id = rf.review_id
WHERE r.is_flagged = true
AND r.is_hidden = false
GROUP BY r.id, p.full_name
ORDER BY flag_count DESC;
```

Admin actions:
- ‚úÖ Approve (unmark as flagged)
- üö´ Hide review
- ‚õî Ban user
- üìù Add moderator note

## Testing Checklist

- [ ] Can only review after event ends
- [ ] Can't review yourself
- [ ] Can't review same person twice for same event
- [ ] QR code scanning works
- [ ] Verified badge shows correctly
- [ ] Can edit within 48 hours
- [ ] Can't edit after 48 hours
- [ ] Profanity auto-flagging works
- [ ] Flag button works
- [ ] Response system works
- [ ] Stats show correctly (above 5 reviews)
- [ ] Feature flags work (can disable system)
- [ ] Helpful votes work
- [ ] Review deletion works (within 48h)

## Future Enhancements

1. **Photo reviews** - Upload photos with reviews
2. **Review templates** - Quick review options ("Great!", "On time", "Friendly")
3. **Review reminders** - Email 24h after event
4. **Trending reviewers** - "Most helpful reviewer" badges
5. **Review insights** - Dashboard for hosts showing common feedback
6. **Anonymous reviews** - Optional anonymous mode
7. **Review rewards** - Points/badges for leaving helpful reviews

## SQL to Run

Run the migration in your Supabase SQL Editor:
```bash
# Run the migration file
cat supabase/migrations/20250118_add_review_system.sql
```

Then manually refresh stats periodically:
```sql
SELECT refresh_review_stats();
```

Or set up a cron job (Supabase has pg_cron):
```sql
-- Refresh review stats every night at 2 AM
SELECT cron.schedule('refresh-review-stats', '0 2 * * *', 'SELECT refresh_review_stats()');
```

## Support

If reviews aren't working as expected:
1. Check feature flags are enabled
2. Verify event has ended
3. Confirm user attended event
4. Check for existing review
5. Look at browser console for errors
6. Query database directly to debug

---

**Remember:** This system is designed to be **fair, transparent, and abuse-resistant** while being **completely toggleable** if it doesn't work out. Start with it enabled, monitor closely for the first month, and adjust based on real usage patterns.
